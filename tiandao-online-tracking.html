<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>å¤©é“æ‰«ç  Â· è”ç½‘è¿å•ç™»è®° v0.2</title>
  <style>
    :root{
      --bg:#020617;--panel:#02091A;--card:#020617;
      --muted:#9ca3af;--text:#e5e7eb;--accent:#38bdf8;
      --good:#22c55e;--bad:#f97373;--line:#1f2937;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans",sans-serif;
      background:radial-gradient(circle at top,#0b1120 0,#020617 55%,#000 100%);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:20px;}
    h1{margin:0 0 6px;font-size:18px;}
    .sub{font-size:12px;color:var(--muted);}
    .panel{
      margin-top:14px;
      background:radial-gradient(circle at top,#020617,#020617);
      border-radius:14px;
      border:1px solid #111827;
      box-shadow:0 18px 45px rgba(0,0,0,.75);
      padding:14px 16px 18px;
    }
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    input,select,button{
      font:inherit;
      border-radius:9px;
      border:1px solid #1f2937;
      background:#020617;
      color:var(--text);
      height:32px;
      padding:0 10px;
      outline:none;
    }
    input::placeholder{color:#6b7280;}
    .btn{
      cursor:pointer;
      background:linear-gradient(135deg,#0ea5e9,#0369a1);
      border-color:#0284c7;
      color:#e5f3ff;
      padding:0 16px;
      font-weight:500;
      box-shadow:0 0 0 1px #0ea5e965 inset,0 8px 18px rgba(15,118,190,.65);
    }
    .btn:hover{filter:brightness(1.05);}
    .btn.sec{
      background:linear-gradient(135deg,#111827,#020617);
      border-color:#374151;
      box-shadow:none;
    }
    .status{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
    }
    table{
      margin-top:10px;
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    thead{background:#020617;}
    th,td{
      padding:6px 8px;
      border-bottom:1px solid #111827;
      text-align:left;
      white-space:nowrap;
    }
    tbody tr:nth-child(even){background:#020617;}
    .tag-badge{
      display:inline-flex;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid #1d4ed8;
      color:#bfdbfe;
      font-size:11px;
      background:rgba(37,99,235,.15);
    }
    .time{color:#9ca3af;font-size:11px;}
    .err{color:#fecaca;}
    .ok{color:#bbf7d0;}
  </style>
</head>
<body>
<div class="wrap">
  <h1>å¤©é“æ‰«ç  Â· è”ç½‘è¿å•ç™»è®° v0.2</h1>
  <div class="sub">
    å½“å‰ç‰ˆæœ¬ï¼šåªåšã€Œè¿å•ç™»è®°ã€è”ç½‘æµ‹è¯•ï¼Œæ•°æ®ç›´æ¥å†™å…¥ Supabase çš„ <code>tracking</code> è¡¨ã€‚
  </div>

  <div class="panel">
    <div class="row" style="margin-bottom:8px;">
      <input id="tagInput" style="min-width:140px;flex:1;"
             placeholder="æ ‡ç­¾ï¼ˆå¦‚ U1 / U2ï¼Œå¯é€‰ï¼‰"/>
      <input id="trackingInput" style="min-width:200px;flex:2;"
             placeholder="æ‰«ææˆ–è¾“å…¥è¿å•å·ï¼ˆUPS 1Z... / FedEx æ•°å­—ï¼‰"/>
      <select id="carrierMode" style="width:110px;">
        <option value="auto">è‡ªåŠ¨è¯†åˆ«</option>
        <option value="UPS">å¼ºåˆ¶ UPS</option>
        <option value="FedEx">å¼ºåˆ¶ FedEx</option>
      </select>
      <input id="noteInput" style="min-width:180px;flex:1;"
             placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"/>
      <button id="btnSave" class="btn">ç™»è®° + å†™å…¥äº‘ç«¯</button>
      <button id="btnRefresh" class="btn sec">åˆ·æ–°åˆ—è¡¨</button>
    </div>
    <div id="status" class="status">å°±ç»ªã€‚</div>

    <table>
      <thead>
      <tr>
        <th style="width:60px;">ID</th>
        <th style="width:140px;">æ—¶é—´</th>
        <th style="width:80px;">æ ‡ç­¾</th>
        <th>è¿å•å·</th>
        <th style="width:80px;">æ‰¿è¿å•†</th>
        <th>å¤‡æ³¨</th>
      </tr>
      </thead>
      <tbody id="listBody"></tbody>
    </table>
  </div>
</div>

<!-- Supabase JS v2 -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ========= 1. è¿™é‡Œæ¢æˆä½ è‡ªå·±çš„ Supabase é¡¹ç›®ä¿¡æ¯ =========
  // ğŸ‘‡ æŠŠè¿™ä¸¤è¡Œæ›¿æ¢æˆä½ çš„çœŸå® URL å’Œ anon keyï¼ˆè·Ÿæµ‹è¯•é¡µé¢é‡Œç”¨çš„ä¸€æ¨¡ä¸€æ ·ï¼‰
  const SUPABASE_URL = 'https://vkqnvvnidkwtzudflmop.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZrcW52dm5pZGt3dHp1ZGZsbW9wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNjg2MzEsImV4cCI6MjA3OTc0NDYzMX0.du7y_gtrz_AiKhQljrARkCMiOtsgxM47ww9HDCCOqAQ';

  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = id => document.getElementById(id);
  const statusEl = $('status');
  const listBody = $('listBody');

  function setStatus(msg, cls){
    statusEl.textContent = msg;
    statusEl.className = 'status ' + (cls || '');
  }

  // ========= 2. è¿å•è¯†åˆ«ï¼ˆå’Œæœ¬åœ°ç‰ˆæœ¬ç±»ä¼¼çš„è§„åˆ™ï¼‰ =========
  function normalizeTracking(raw, forceType){
    let s = (raw || '').toUpperCase().trim().replace(/\s+/g,'');
    let type = 'Unknown';
    if(forceType && forceType !== 'auto') type = forceType;
    if(!forceType || forceType === 'auto'){
      if(/^1Z[0-9A-Z]{16}$/.test(s)) type = 'UPS';
      else if(/^\d{12,34}$/.test(s)) type = 'FedEx';
    }
    // FedExï¼šåªä¿ç•™å 12 ä½
    if(type === 'FedEx' && /^\d+$/.test(s) && s.length > 12){
      s = s.slice(-12);
    }
    return { tracking: s, type };
  }

  // ========= 3. åˆ·æ–°åˆ—è¡¨ =========
  async function refreshList(){
    setStatus('æ­£åœ¨ä» Supabase è¯»å–æ•°æ®â€¦');
    listBody.innerHTML = '';
    try{
      const { data, error } = await client
        .from('tracking')
        .select('*')
        .order('id',{ascending:false})
        .limit(50);

      if(error){
        console.error('è¯»å–é”™è¯¯', error);
        setStatus('è¯»å–å¤±è´¥ï¼š' + (error.message || error), 'err');
        return;
      }

      if(!data || !data.length){
        setStatus('è¿æ¥æˆåŠŸï¼Œä½†å½“å‰ tracking è¡¨æ²¡æœ‰æ•°æ®ã€‚', 'ok');
        return;
      }

      setStatus('è¯»å–æˆåŠŸï¼Œå…± ' + data.length + ' æ¡ã€‚','ok');
      data.forEach(row=>{
        const tr = document.createElement('tr');
        const dt = new Date(row.created_at);
        const timeStr = isNaN(dt) ? (row.created_at || '') :
          dt.toLocaleString('zh-CN',{hour12:false});

        tr.innerHTML =
          `<td>${row.id}</td>`+
          `<td class="time">${timeStr}</td>`+
          `<td>${row.tag_text ? '<span class="tag-badge">'+row.tag_text+'</span>' : ''}</td>`+
          `<td>${row.tracking_no||''}</td>`+
          `<td>${row.carrier||''}</td>`+
          `<td>${row.note||''}</td>`;
        listBody.appendChild(tr);
      });

    }catch(err){
      console.error('åˆ·æ–°æ—¶å¼‚å¸¸', err);
      setStatus('è¯»å–å¤±è´¥ï¼ˆæµè§ˆå™¨ Fetch é”™è¯¯ï¼‰ï¼š' + err, 'err');
    }
  }

  // ========= 4. å†™å…¥ä¸€æ¡ =========
  async function saveOne(){
    const tag = $('tagInput').value.trim();
    const rawTracking = $('trackingInput').value.trim();
    const mode = $('carrierMode').value;
    const note = $('noteInput').value.trim();

    if(!rawTracking){
      alert('è¯·å…ˆè¾“å…¥è¿å•å·');
      $('trackingInput').focus();
      return;
    }

    const { tracking, type } = normalizeTracking(rawTracking, mode);
    if(!tracking || (type!=='UPS' && type!=='FedEx')){
      alert('è¿å•æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ç¡®è®¤æ˜¯å¦ UPS 1Z... æˆ– FedEx æ•°å­—ã€‚');
      return;
    }

    setStatus('æ­£åœ¨å†™å…¥ Supabaseâ€¦');
    try{
      const { data, error } = await client
        .from('tracking')
        .insert([{
          tag_text: tag || null,
          tracking_no: tracking,
          carrier: type,
          note: note || null
        }])
        .select();

      if(error){
        console.error('å†™å…¥é”™è¯¯', error);
        alert('å†™å…¥å¤±è´¥ï¼š' + (error.message || error));
        setStatus('å†™å…¥å¤±è´¥ã€‚', 'err');
        return;
      }

      alert('å†™å…¥æˆåŠŸï¼');
      $('trackingInput').value = '';
      $('noteInput').value = '';
      setStatus('å†™å…¥æˆåŠŸï¼Œæ­£åœ¨åˆ·æ–°åˆ—è¡¨â€¦', 'ok');
      await refreshList();

    }catch(err){
      console.error('å†™å…¥æ—¶å‘ç”Ÿå¼‚å¸¸', err);
      alert('å†™å…¥å¤±è´¥ï¼ˆæµè§ˆå™¨ Fetch é”™è¯¯ï¼‰ï¼š' + err);
      setStatus('å†™å…¥å¤±è´¥ï¼ˆFetch é”™è¯¯ï¼‰ã€‚', 'err');
    }
  }

  $('btnSave').addEventListener('click', saveOne);
  $('btnRefresh').addEventListener('click', refreshList);

  // é¡µé¢åŠ è½½åè‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
  refreshList();
</script>
</body>
</html>
